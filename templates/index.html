<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtrar por Peso - EMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Librerías para PDF y Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>

    <style>
        body {
            background-color: #f4f7fa;
            font-family: 'Arial', sans-serif;
        }

        .container {
            margin-top: 50px;
        }

        .header {
            background-color: #005EAA; /* Mercado Libre Blue */
            padding: 25px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .header img {
            width: 150px;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #FFD500; /* Mercado Libre Yellow */
            border-color: #FFD500;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #E6C200;
            border-color: #E6C200;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .form-label {
            font-weight: bold;
        }

        #tableContainer {
            margin-top: 30px;
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            background-color: #343a40;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            margin-top: 20px;
            table-layout: fixed;
        }

        th, td {
            text-align: center;
            vertical-align: middle;
            padding: 12px;
            font-size: 1rem;
            word-wrap: break-word;
        }

        th {
            background-color: #f1f1f1;
            color: #495057;
            font-weight: 600;
        }

        .table-container {
            max-width: 100%;
            overflow-x: auto;
        }

        #packageCount, #filterTime {
            position: fixed;
            bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            background-color: #FFD500; /* Mercado Libre Yellow */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #packageCount {
            right: 20px;
        }

        #filterTime {
            left: 20px;
        }

        .horizontal-gap {
            margin-right: 15px;
        }

        .d-flex input, .d-flex button {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .d-flex input:focus, .d-flex button:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Reducción de espacio vertical */
        .form-group {
            margin-bottom: 10px;
        }

        .d-flex {
            gap: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Ajuste de los tamaños de los botones y campos */
        .form-control, .btn {
            height: 38px;
            font-size: 1rem;
        }

        .header h2 {
            font-size: 1.5rem;
        }

        #uploadForm, #filterForm {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Sube y Filtra tus Archivos Excel</h2>
        </div>

        <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
            <div class="d-flex align-items-center">
                <label for="fileInput" class="form-label mb-0">Seleccionar un archivo</label>
                <input type="file" id="fileInput" name="file" class="form-control" required>
                <button type="submit" class="btn btn-primary">Cargar archivo</button>
            </div>
        </form>

        <form id="filterForm" class="mb-4">
            <div class="d-flex align-items-center">
                <label for="filterWeight" class="form-label mb-0">Defina un peso</label>
                <input type="number" id="filterWeight" class="form-control" placeholder="Ingrese el peso en Kg">
                <button type="button" id="filterButton" class="btn btn-success">Filtrar por peso</button>
            </div>
        </form>

        <div class="btn-group">
            <button id="downloadPDF" class="btn btn-danger">Descargar PDF</button>
            <button id="downloadExcel" class="btn btn-info">Descargar en Excel</button>
        </div>

        <div id="tableContainer" class="mt-4"></div>

        <div class="footer">
            <p>&copy; 2025 Mercado Libre. Todos los derechos reservados.</p>
        </div>
    </div>

    <div id="packageCount">
        <p><strong>Total de Paquetes: </strong><span id="totalPackages">0</span></p>
    </div>

    <div id="filterTime">
        <p><strong>Hora de filtrado: </strong><span id="filterTimestamp">N/A</span></p>
    </div>

    <script>
        $(document).ready(function () {
            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();
                const fileInput = $('#fileInput')[0].files[0];
                if (!fileInput) {
                    alert('Por favor selecciona un archivo.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput);

                $('#tableContainer').html('<p class="text-center text-secondary">Cargando archivo...</p>');

                $.ajax({
                    url: '/upload',
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        if (response.success) {
                            $('#tableContainer').html(`<h3 class="mt-4">Tabla Original</h3><div class="table-container">${response.table_html}</div>`);
                            $('#filterButton').show();
                            $('#totalPackages').text(response.totalPackages);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('Error al cargar el archivo.');
                    }
                });
            });

            $('#filterButton').on('click', function () {
                const weight = $('#filterWeight').val();
                if (!weight || isNaN(weight)) {
                    alert('Por favor ingresa un peso válido.');
                    return;
                }

                $('#tableContainer').html('<p class="text-center text-secondary">Filtrando registros...</p>');

                $.ajax({
                    url: '/filter',
                    method: 'GET',
                    data: { weight },
                    success: function (response) {
                        if (response.success) {
                            $('#tableContainer').html(`
                                <h3 class="mt-4 text-success">Registros Filtrados (Peso > ${weight} Kg)</h3>
                                <div class="table-container">${response.filtered_table_html}</div>
                            `);
                            $('#totalPackages').text(response.filteredPackages);
                            $('#filterTimestamp').text(new Date().toLocaleString());
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('Error al filtrar los registros.');
                    }
                });
            });

            $('#downloadExcel').on('click', function () {
                const table = $('#tableContainer').find('table')[0];
                const wb = XLSX.utils.table_to_book(table, { sheet: "Paquetes" });
                XLSX.writeFile(wb, 'Paquetes.xlsx');
            });

            $('#downloadPDF').on('click', function () {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.html($('#tableContainer').find('table')[0], {
                    callback: function (doc) {
                        doc.save('Paquetes.pdf');
                    },
                    margin: [20, 20, 20, 20],
                    autoPaging: true
                });
            });
        });
    </script>
</body>
</html>
